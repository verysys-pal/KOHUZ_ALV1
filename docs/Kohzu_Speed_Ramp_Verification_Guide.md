# Kohzu XA07A-L202 속도 램프 검증 가이드

## 1. 개요 (Overview)

| 항목 | 내용 |
|---|---|
| **스크립트** | `iocBoot/iocKOHUZ_ALV1/verify_20mm_speed_ramp.sh` |
| **대상 시스템** | Kohzu ARIES/LYNX Controller + XA07A-L202 Stage |
| **목 적** | 속도를 단계적으로 증가시키며 전/후진 20mm 이동을 반복하여 위치 정밀도, 속도 응답성, 탈조 유무를 검증 |
| **소요 시간** | 약 10~15분 (10 사이클, 저속~고속) |
| **전제 조건** | IOC 정상 가동, 모터 원점 복귀 완료, 이동 범위 내 장애물 없음 |

---

## 2. 테스트 파라미터 (Test Parameters)

### 2.1 스크립트 설정 변수

스크립트 상단에서 아래 변수를 수정하여 테스트 조건을 변경할 수 있습니다.

| 변수 | 기본값 | 설명 |
|---|---|---|
| `MOTOR_PV` | `KOHZU:m1` | 테스트 대상 모터 PV Prefix |
| `MOVE_DIST` | `20.0` | 전진/후진 이동 거리 (mm) |
| `TOTAL_CYCLES` | `10` | 전진+후진 1사이클 × 반복 횟수 |
| `BASE_VELO` | `0.5` | 시작 속도 (mm/s) |
| `VELO_STEP` | `0.4` | 매 사이클 속도 증가량 (mm/s) |
| `TIMEOUT_SEC` | `120` | 이동 완료 대기 타임아웃 (초) |

### 2.2 사이클별 속도 테이블

| 사이클 | 속도 (mm/s) | 예상 소요 시간 (편도) | 비고 |
|---|---|---|---|
| #1 | 0.5 | ~40.0 s | 최저속 기준 |
| #2 | 0.9 | ~22.2 s | |
| #3 | 1.3 | ~15.4 s | |
| #4 | 1.7 | ~11.8 s | |
| #5 | 2.1 | ~9.5 s | |
| #6 | 2.5 | ~8.0 s | |
| #7 | 2.9 | ~6.9 s | |
| #8 | 3.3 | ~6.1 s | |
| #9 | 3.7 | ~5.4 s | |
| #10 | **4.1** | ~4.9 s | VMAX(4.0) 부근 |

### 2.3 속도 제한 근거

```
XA07A-L202 사양:
  모터: PK523HPMB (5-phase stepper, 0.36°/step)
  Lead: 1.0 mm/rev
  Half-step: 2000 steps/rev → MRES = 0.0005 mm/step

5-phase 스테퍼 일반 응답 주파수: ~10 kHz
  → 이론적 최대 속도 = 10,000 × 0.0005 = 5.0 mm/s

안전 계수 80% 적용:
  → 권장 VMAX = 4.0 mm/s

※ 4.0 mm/s 초과 시 토크 저하로 인한 탈조(Step Loss) 위험
```

---

## 3. 실행 방법 (How to Run)

### 3.1 사전 준비

```bash
# 1. IOC 가동 확인
caget KOHZU:m1.VAL

# 2. 현재 위치 확인 (이동 범위 내인지 확인)
caget KOHZU:m1.RBV
# ※ 전진 20mm + 현재 위치가 HLM(34.0) 이내여야 합니다.
# ※ 후진 20mm - 현재 위치가 LLM(-34.0) 이상이어야 합니다.

# 3. 안전한 시작 위치로 이동 (권장: 원점 부근)
caput KOHZU:m1.VAL 0
```

### 3.2 스크립트 실행

```bash
cd /usr/local/epics/EPICS_R7.0/siteApp/KOHUZ_ALV1/iocBoot/iocKOHUZ_ALV1

# 기본 실행
./verify_20mm_speed_ramp.sh

# 로그 파일로 저장 (권장)
./verify_20mm_speed_ramp.sh 2>&1 | tee Log_speed_ramp_$(date +%Y%m%d_%H%M%S).log
```

### 3.3 파라미터 변경 실행 예시

```bash
# 스크립트 내 변수를 수정하지 않고 빠르게 테스트하려면:
# 스크립트를 복사하여 변수를 수정합니다.

# 예: 10mm 이동, 5사이클, 속도 1.0~3.0 mm/s
cp verify_20mm_speed_ramp.sh verify_custom.sh
sed -i 's/MOVE_DIST=20.0/MOVE_DIST=10.0/' verify_custom.sh
sed -i 's/TOTAL_CYCLES=10/TOTAL_CYCLES=5/' verify_custom.sh
sed -i 's/BASE_VELO=0.5/BASE_VELO=1.0/' verify_custom.sh
./verify_custom.sh
```

---

## 4. 출력 형식 (Output Format)

### 4.1 실행 중 출력 예시

```
=================================================================
 [20mm Speed Ramp Test] Target: KOHZU:m1
 이동 거리: ±20.0mm × 10회
 속도 범위: 0.5 ~ 4.1 mm/s
=================================================================
✅ IOC 연결 확인 완료.
초기 위치: 0.0015 mm
원래 속도: 5.0 mm/s

=================================================================
Cycle  VELO       방향     거리(mm)  시간(s)    실속도     오차(mm)  결과
-----------------------------------------------------------------
#1     0.5        전진     20.0000   40.12      0.499      0.0000   ✅
#1     0.5        후진     20.0000   40.08      0.499      0.0000   ✅
#2     0.9        전진     20.0000   22.28      0.898      0.0000   ✅
#2     0.9        후진     20.0000   22.25      0.899      0.0000   ✅
...
#10    4.1        전진     20.0000   4.92       4.065      0.0000   ✅
#10    4.1        후진     20.0000   4.89       4.090      0.0000   ✅
=================================================================

===============================
       최종 검증 리포트
===============================
총 이동 횟수: 20회 (전진 10 + 후진 10)
  ✅ PASS: 20건
  ❌ FAIL: 0건

초기 위치:  0.0015 mm
최종 위치:  0.0015 mm
누적 드리프트: 0.0000 mm

속도 원복: VELO=5.0 mm/s

🎉 전 사이클 PASS — 검증 완료!
===============================
```

### 4.2 출력 컬럼 설명

| 컬럼 | 설명 |
|---|---|
| **Cycle** | 사이클 번호 (#1 ~ #10) |
| **VELO** | 해당 사이클에서 설정된 속도 (mm/s) |
| **방향** | 전진(+) 또는 후진(-) |
| **거리(mm)** | 실제 이동한 거리 (`|RBV_after - RBV_before|`) |
| **시간(s)** | 이동 소요 시간 (caput ~ DMOV=1) |
| **실속도** | 실측 평균 속도 (거리 / 시간) |
| **오차(mm)** | `|실제 거리 - 목표 거리|`, 0.01mm 미만이면 PASS |
| **결과** | ✅ PASS / ❌ FAIL |

---

## 5. 판정 기준 (Pass/Fail Criteria)

### 5.1 개별 이동 판정

| 항목 | PASS 조건 | FAIL 시 의심 원인 |
|---|---|---|
| **위치 오차** | `|실제 거리 - 목표 거리| < 0.01 mm` | 탈조(Step Loss), 백래시 |
| **타임아웃** | `TIMEOUT_SEC` 이내 DMOV=1 | DMOV 고착, 통신 에러 |

### 5.2 전체 테스트 판정

| 항목 | PASS 조건 | FAIL 시 의심 원인 |
|---|---|---|
| **전 사이클 PASS** | FAIL = 0건 | 특정 속도 이상에서만 실패 시 탈조 의심 |
| **누적 드리프트** | `< 0.01 mm` (시작 위치 ≒ 최종 위치) | 백래시, 분해능 설정 오류 |

### 5.3 속도별 이상 진단 가이드

| 증상 | 가능 원인 | 조치 방안 |
|---|---|---|
| 저속에서만 FAIL | DMOV 감지 문제 (STR 파싱) | `poll()` 로그 확인, 트러블슈팅 리포트 §3.4 참조 |
| 고속(3.5+)에서 FAIL | 탈조 (토크 부족) | `VMAX` 설정 하향, 드라이버 전류 확인 |
| 모든 속도에서 FAIL | 통신 에러 또는 설정 오류 | IOC 콘솔 로그, `asynSetTraceMask` 디버깅 |
| 오차가 일정 패턴 | 백래시 (Backlash) | `.BDST` 필드 설정, 기구부 점검 |
| 드리프트 누적 | 펄스 누락 또는 기구 슬립 | 원점 복귀 후 재검증, 엔코더 도입 검토 |

---

## 6. 스크립트 구조 (Script Architecture)

### 6.1 전체 흐름

```
┌─────────────────────────────────────┐
│ 1. IOC 연결 확인                       │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│ 2. 초기 상태 기록 (위치, 속도)           │
└──────────────┬──────────────────────┘
               │
       ┌───────▼───────┐
       │ for i = 1..10 │ ◀── 사이클 루프
       └───────┬───────┘
               │
    ┌──────────▼──────────┐
    │ VELO = BASE + STEP  │
    │       × (i - 1)     │
    └──────────┬──────────┘
               │
    ┌──────────▼──────────┐
    │ 전진 +20mm (caput)   │──▶ wait_for_done()
    │ 거리/시간/속도 계산    │      │
    │ PASS/FAIL 판정        │      │ DMOV 폴링 (0.5s 간격)
    └──────────┬──────────┘      │ 타임아웃 감시
               │                   │
    ┌──────────▼──────────┐      │
    │ 후진 -20mm (caput)   │──▶ wait_for_done()
    │ 거리/시간/속도 계산    │
    │ PASS/FAIL 판정        │
    └──────────┬──────────┘
               │
       ┌───────▼───────┐
       │   다음 사이클    │
       └───────┬───────┘
               │ (10사이클 완료)
    ┌──────────▼──────────┐
    │ 4. 최종 리포트        │
    │  - PASS/FAIL 집계     │
    │  - 누적 드리프트 계산  │
    │  - 속도 원복           │
    └──────────────────────┘
```

### 6.2 핵심 함수

#### `wait_for_done()`

이동 완료를 기다리는 함수. 다음 조건을 처리합니다:

| 상황 | 동작 |
|---|---|
| `DMOV=1` | 즉시 return 0 (성공) |
| `caget` 실패 | 재시도, 타임아웃 카운트에 포함 |
| 타임아웃 초과 | `STOP` 명령 전송 후 return 1 (실패) |
| 정상 대기 중 | 5초 간격으로 DMOV/RBV 디버그 출력 |

#### `get_time_ms()`

Python3의 `time.time()`을 사용하여 밀리초 정밀도의 타임스탬프를 반환합니다.
bash의 `date +%s`보다 정밀한 소요 시간 측정이 가능합니다.

---

## 7. 관련 문서 (Related Documents)

| 문서 | 경로 | 설명 |
|---|---|---|
| 트러블슈팅 리포트 | `doc/Kohzu_ARIES_Driver_Troubleshooting_Report.md` | DMOV 고착, 타임아웃 등 이슈 해결 기록 |
| 제어 가이드 | `doc/XA07A-L202_Control_Guide.md` | PV 설정, MRES 계산, 속도 제한 사양 |
| 시스템 검증 가이드 | `doc/KOHZU_System_Verification_Guide.md` | 전체 IOC 검증 시나리오 |
| 기본 10mm 검증 | `iocBoot/iocKOHUZ_ALV1/verify_10mm_move.sh` | 단순 전/후진 10mm 검증 스크립트 |
| motor.substitutions | `iocBoot/iocKOHUZ_ALV1/motor.substitutions` | EPICS 모터 레코드 설정값 |

---

## 8. 주의 사항 (Precautions)

### ⚠️ 실행 전 체크리스트

- [ ] IOC가 정상 가동 중인가? (`caget KOHZU:m1.VAL` 응답 확인)
- [ ] 현재 위치에서 ±20mm 이동 시 소프트 리미트(±34mm)를 초과하지 않는가?
- [ ] 스테이지 이동 경로에 물리적 장애물이 없는가?
- [ ] 드라이버 전류 설정이 정격(0.75 A/phase) 이내인가?

### ⚠️ 비상 정지

스크립트 실행 중 비상 정지가 필요한 경우:

```bash
# 방법 1: 별도 터미널에서 STOP 명령
caput KOHZU:m1.STOP 1

# 방법 2: 스크립트 강제 종료 (Ctrl+C)
# → 모터가 즉시 정지하지 않을 수 있으므로, 반드시 위의 STOP 명령을 추가 실행
```

### ⚠️ 테스트 후 확인

- 속도(`VELO`)가 원래 값으로 복원되었는지 확인: `caget KOHZU:m1.VELO`
- 스크립트가 정상 종료되면 자동으로 원래 속도로 복원됩니다.
- 스크립트가 비정상 종료(Ctrl+C)된 경우 수동으로 복원하세요: `caput KOHZU:m1.VELO <원래값>`

---

**작성일**: 2026-02-13
**작성자**: MHDev / Antigravity Assistant
